<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Crypt surfer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.8.2/pixi.min.js"></script>
    <style>* {padding: 0; margin: 0}</style>
  </head>
  <body>
    <script>

const CONF = {
  width: 1024,
  height: 768,
  antialias: true,
  transparent: false,
  resolution: 1
};

const app = new PIXI.Application(CONF);
const W = window.innerWidth
const H = window.innerHeight
// Full screen
app.renderer.view.style.position = 'absolute';
app.renderer.view.style.display = 'block';
app.renderer.autoResize = true;
app.renderer.resize(W, H);

document.body.appendChild(app.view);

const BITCOIN_PRICE = 'https://api.coindesk.com/v1/bpi/historical/close.json?start=2013-01-01&end=2014-01-01&currency=USD'

PIXI.loader
  .add('bg', 'bg_tile.jpg')
  .add('prices', BITCOIN_PRICE)
  .load(setup);

const TEXT_STYLE = new PIXI.TextStyle({
  fontFamily: "Arial",
  fontSize: 18,
  fill: "#ff0000",
});


const ENTITIES = {
  bgSprites: [],
  player: null,
  messages: {
    iteration: null,
  },
  lines: [],
}

var priceData

function setup() {
  priceData = parsePriceData(PIXI.loader.resources.prices.data)
  console.log(priceData.scale)
  const bgTexture = PIXI.loader.resources.bg.texture
  const w = bgTexture.width
  const h = bgTexture.height
  for (let i = -w; i < W; i += w) {
    for (let j = -h; j < H; j += h) {
      let bgSprite = new PIXI.Sprite(bgTexture)
      bgSprite.position.set(i, j)
      app.stage.addChild(bgSprite);
      ENTITIES.bgSprites.push(bgSprite)
    }
  }

  ENTITIES.player = new PIXI.Graphics()
  ENTITIES.player.lineStyle(2, 0xFF00FF)
  ENTITIES.player.drawCircle(W/2, H/2, 4)
  ENTITIES.player.endFill()
  app.stage.addChild(ENTITIES.player)

  ENTITIES.messages.iteration = new PIXI.Text('tick: ', TEXT_STYLE)
  ENTITIES.messages.iteration.position.set(4, 4)
  app.stage.addChild(ENTITIES.messages.iteration);

  app.ticker.add(update);
}

var time = 0
const LINE_WIDTH = 10

var diff

var iterationLabel

function update(dt) {
  time += dt / 60
  var i = Math.floor(time)
  if (ENTITIES.lines.length === priceData.series.length) {
    return // TODO: end of level
  }
  if (ENTITIES.lines.length === i) {
    ENTITIES.messages.iteration.text = 'tick: ' + i + ' / ' + priceData.series.length
    let line = new PIXI.Graphics();
    line.position.set(W/2, H/2);

    diff = priceData.series[i + 1] - priceData.series[i]
    // Draw the line (endPoint should be relative to myGraph's position)
    line.lineStyle(1, 0xff0000)
        .moveTo(0, 0)
        .lineTo(LINE_WIDTH, -priceData.scale * diff)

    ENTITIES.lines.push(line)
    app.stage.addChild(line)
  }
  ENTITIES.lines.forEach(line => {
    line.x -= LINE_WIDTH / 60 * dt
    line.y += priceData.scale * diff / 60 * dt
  })

}

function parsePriceData(data) {
  const days = Object.keys(data.bpi)
  days.sort()
  const series = days.map(day => data.bpi[day])
  return {
    series: series,
    min: Math.min(...series),
    max: Math.max(...series),
    scale: 10 // / Math.abs(series[0] - series[1])
  }
}

    </script>
  </body>
</html>
